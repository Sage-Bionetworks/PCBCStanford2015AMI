{
    "variables": {
	"aws_access_key": "{{env `AWS_ACCESS_KEY`}}",
	"aws_secret_key": "{{env `AWS_SECRET_KEY`}}"
    },

    "builders": [
	{
	    "type": "amazon-ebs",
	    "access_key": "{{user `aws_access_key`}}",
	    "secret_key": "{{user `aws_secret_key`}}",
	    "region": "us-east-1",
	    "source_ami": "ami-f9ceb79c",
	    "ssh_username": "ubuntu",
	    "ami_name": "ubuntu-PCBC Seattle 2016 {{timestamp}}",
	    "instance_type": "m3.xlarge"
    },
	{
	     "type": "docker",
	     "image": "ubuntu:14.04",
	     "export_path": "pcbc_docker_image.tar"
	 }],

     "provisioners": [
         {"type": "shell",
          "inline": ["apt-get update"],
          "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
          "only": ["amazon-ebs", "docker"]
     },
         {"type": "shell",
          "inline": ["sed -i -e 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config",
                    "service ssh restart"],
          "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
          "only": ["amazon-ebs"]
     },
	{
	    "type": "shell",
	    "scripts": ["ec2provisioner.sh"],
	    "pause_before": "10s",
	    "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
	    "only": ["amazon-ebs", "docker"]
	},
  {
	    "type": "shell",
	    "scripts": ["r_provisioner.sh", "python_provisioner.sh", "bioinfo_provisioner.sh", "altanalyze_provisioner.sh", "synapseprovisioner.sh"],
      "pause_before": "10s",
	    "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
	    "only": ["amazon-ebs", "docker"]
	},
  {
    "type": "shell",
    "inline": ["apt-get install -y libjpeg62",
               "wget https://s3.amazonaws.com/rstudio-dailybuilds/rstudio-0.99.691-amd64.deb -P /root/",
               "dpkg -i /root/rstudio-0.99.691-amd64.deb",
               "wget https://download2.rstudio.org/rstudio-server-0.99.484-amd64.deb -P /root/",
               "dpkg -i /root/rstudio-server-0.99.484-amd64.deb"],
     "pause_before": "10s",
     "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
     "only": ["amazon-ebs"]
  },
    {
	    "type": "shell",
	    "scripts": ["x2go_provisioner.sh"],
	    "pause_before": "10s",
	    "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
	    "only": ["amazon-ebs"]
	},
    {
        "type": "shell",
        "scripts": ["vnc_provisioner.sh"],
        "pause_before": "10s",
        "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
        "only": ["docker"]
    },
    {
        "type": "file",
        "source": "./bioinfo_paths.sh",
        "destination": "/tmp/bioinfo_paths.sh"
    },
    {
      "type": "shell",
      "inline": ["cp /tmp/bioinfo_paths.sh /etc/profile.d/"],
       "pause_before": "10s",
       "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
       "only": ["docker", "amazon-ebs"]
   },
    {
      "type": "shell",
      "inline": ["rm -rf /tmp/downloaded_packages/ /tmp/*.rds",
                 "rm -rf /var/lib/apt/lists/*"],
       "pause_before": "10s",
       "execute_command": "{{ .Vars }} sudo -E sh '{{ .Path }}'",
       "only": ["docker", "amazon-ebs"]
    }
    ],

    "post-processors": [
        []
    ]

}
